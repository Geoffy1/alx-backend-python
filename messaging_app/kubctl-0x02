#!/usr/bin/env bash

# This script deploys the blue and green versions of the app
# and manages the service selector to switch traffic.

BLUE_DEPLOYMENT="messaging-app-blue"
GREEN_DEPLOYMENT="messaging-app-green"
SERVICE_NAME="messaging-app-service"

echo "Deploying the blue version..."
kubectl apply -f blue_deployment.yaml

echo -e "\nDeploying the green version (new version)..."
kubectl apply -f green_deployment.yaml

echo -e "\nDeploying the service..."
kubectl apply -f kubeservice.yaml

# Wait for all deployments to be ready
kubectl rollout status deployment "$BLUE_DEPLOYMENT"
kubectl rollout status deployment "$GREEN_DEPLOYMENT"

echo -e "\nTraffic is currently routed to the blue version."
echo "Checking logs for the new green version to ensure it started correctly:"
GREEN_POD=$(kubectl get pods -l version=green -o jsonpath="{.items[0].metadata.name}")
kubectl logs "$GREEN_POD"

echo -e "\nTo switch traffic to the green version, you would run:"
echo "kubectl patch service $SERVICE_NAME -p '{\"spec\":{\"selector\": {\"version\": \"green\"}}}'"
echo -e "\nAfter switching, you could then delete the old blue deployment."
